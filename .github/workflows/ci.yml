name: Continuous Integration

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  precommit:
    name: Pre-commit checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install pre-commit
        run: pip install pre-commit==4.1.0

      - name: Run pre-commit on all files
        run: |
          pre-commit run --all-files --show-diff-on-failure --color always --verbose
          echo -e "${GREEN}Job completed successfully${NO_COLOR}"

  html-lint:
    name: HTML validation (tidy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tidy
        run: sudo apt-get update && sudo apt-get install -y tidy
      - name: Validate HTML files
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          FAIL=0
          for f in **/*.html **/*.htm; do
            echo "Checking $f"
            TMP=$(mktemp)
            # Run tidy, capture stderr (tidy writes issues to stderr)
            tidy -q -e --show-warnings no -language en --doctype html5 "$f" 2> "$TMP" || true
            if [ -s "$TMP" ]; then
              echo "--- tidy output for $f ---"
              cat "$TMP"
              echo "--- end tidy output for $f ---"
              # If tidy reported 'Error:' lines, treat as failure
              if grep -q "Error:" "$TMP"; then
                FAIL=1
              fi
            fi
            rm -f "$TMP"
          done
          if [ "$FAIL" -ne 0 ]; then
            echo "HTML tidy found errors"
            exit 1
          fi
